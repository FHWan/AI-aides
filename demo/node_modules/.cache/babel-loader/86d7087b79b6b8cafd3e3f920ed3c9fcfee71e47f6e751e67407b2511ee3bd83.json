{"ast":null,"code":"import { createCommentVNode as _createCommentVNode, createElementVNode as _createElementVNode, vModelText as _vModelText, withKeys as _withKeys, withDirectives as _withDirectives, openBlock as _openBlock, createElementBlock as _createElementBlock } from \"vue\";\nconst _hoisted_1 = {\n  class: \"app\"\n};\nconst _hoisted_2 = {\n  ref: \"liveCanvas\"\n};\nconst _hoisted_3 = [\"value\"];\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  return _openBlock(), _createElementBlock(\"div\", _hoisted_1, [_createCommentVNode(\" 自定义ref=\\\"liveCanvas\\\"： \"), _createElementVNode(\"canvas\", _hoisted_2, null, 512 /* NEED_PATCH */), _createCommentVNode(\" 用户输入框 \"), _withDirectives(_createElementVNode(\"textarea\", {\n    \"onUpdate:modelValue\": _cache[0] || (_cache[0] = $event => $data.userQuestion = $event),\n    class: \"transparent-textarea\",\n    placeholder: \"输入你的问题...\",\n    onKeydown: _cache[1] || (_cache[1] = _withKeys((...args) => $options.sendQuestion && $options.sendQuestion(...args), [\"enter\"]))\n  }, null, 544 /* NEED_HYDRATION, NEED_PATCH */), [[_vModelText, $data.userQuestion]]), _createCommentVNode(\" AI响应展示 \"), _createElementVNode(\"textarea\", {\n    value: $data.aiResponse,\n    class: \"response-textarea\",\n    placeholder: \"AI的回复...\",\n    readonly: \"\"\n  }, null, 8 /* PROPS */, _hoisted_3), _createCommentVNode(\" 新增表情切换按钮 \"), $data.model ? (_openBlock(), _createElementBlock(\"button\", {\n    key: 0,\n    class: \"expression-btn_1\",\n    onClick: _cache[2] || (_cache[2] = $event => $options.changeExpression('1desk'))\n  }, \" 表情1 \")) : _createCommentVNode(\"v-if\", true), $data.model ? (_openBlock(), _createElementBlock(\"button\", {\n    key: 1,\n    class: \"expression-btn_2\",\n    onClick: _cache[3] || (_cache[3] = $event => $options.changeExpression('2mic'))\n  }, \" 表情2 \")) : _createCommentVNode(\"v-if\", true), $data.model ? (_openBlock(), _createElementBlock(\"button\", {\n    key: 2,\n    class: \"expression-btn_3\",\n    onClick: _cache[4] || (_cache[4] = $event => $options.changeExpression('5QAQ'))\n  }, \" 表情3 \")) : _createCommentVNode(\"v-if\", true), $data.model ? (_openBlock(), _createElementBlock(\"button\", {\n    key: 3,\n    class: \"expression-btn_4\",\n    onClick: _cache[5] || (_cache[5] = $event => $options.changeExpression('6i gi a ri'))\n  }, \" 表情4 \")) : _createCommentVNode(\"v-if\", true)]);\n}","map":{"version":3,"names":["class","ref","_createElementBlock","_hoisted_1","_createCommentVNode","_createElementVNode","_hoisted_2","_cache","$event","$data","userQuestion","placeholder","onKeydown","_withKeys","args","$options","sendQuestion","value","aiResponse","readonly","_hoisted_3","model","key","onClick","changeExpression"],"sources":["/home/fan/docker_image/live2d/demo/src/App.vue"],"sourcesContent":["<script>\n// 引入必要的库\nimport * as PIXI from 'pixi.js';\nimport { Live2DModel } from 'pixi-live2d-display/cubism4';\nwindow.PIXI = PIXI; // 为了pixi-live2d-display内部调用\nlet app; // 用于存储pixi实例\n//let model; // 用于存储live2d实例\n\nexport default {\n  data() {\n    return {\n      userQuestion: '',\n      aiResponse: '',\n      ws: null,\n      audioUrl: '',\n      fullResponse: '', // 新增：用于累积完整响应\n      model: null, // 将model移到data中以便Vue响应式管理\n    };\n  },\n\n  async mounted() {\n    app = new PIXI.Application({\n      view: this.$refs.liveCanvas, // ref组件绑定，liveCanvas为下文自定义的\n      autoStart: true,             // 是否开启自动播放\n      resizeTo: window,\n      backgroundAlpha: 0,         // 透明度\n    });\n\n    // 将model实例保存到组件data中\n    this.model = await Live2DModel.from('/UG/ugofficial.model3.json');\n    app.stage.addChild(this.model);\n    this.model.x = 500;\n    this.model.y = 100;\n    this.model.scale.set(1);\n\n  },\n\n  methods: {\n    // 新增表情切换方法\n    changeExpression(text) {\n      if (this.model) {\n        this.model.expression(text);\n      }\n    },\n\n    async sendQuestion(e) {\n      e.preventDefault();\n      if (!this.userQuestion.trim()) return;\n\n      // 清空之前的回复\n      this.aiResponse = ''; // 清空响应内容\n\n      // 确保连接可用\n      if (!this.ws || this.ws.readyState === WebSocket.CLOSED) {\n        await this.initWebSocket();\n      }\n\n      // 确保连接已建立\n      if (this.ws.readyState === WebSocket.CONNECTING) {\n        await new Promise((resolve) => {\n          this.ws.addEventListener('open', resolve);\n        });\n      }\n\n      // 发送消息\n      if (this.ws.readyState === WebSocket.OPEN) {\n        this.ws.send(this.userQuestion);\n        this.userQuestion = '';\n      } else {\n        console.error('WebSocket连接异常状态:', this.ws.readyState);\n        this.aiResponse = \"连接异常，请刷新页面重试\";\n      }\n    },\n\n    initWebSocket() {\n      return new Promise((resolve) => {\n        if (this.ws) {\n          this.ws.close(); // 关闭旧连接\n        }\n\n        this.ws = new WebSocket('ws://localhost:4600/question');\n        \n         // 修改后的消息监听\n         this.ws.addEventListener('message', (event) => {\n          const response = JSON.parse(event.data);\n          \n          // 处理错误情况\n          if (response.error) {\n            this.aiResponse = response.error;\n            return;\n          }\n\n          // 累积响应内容\n          if (response.data) {\n            this.aiResponse += response.data;\n            this.fullResponse += response.data; // 累积完整响应\n          }\n\n          // 自动滚动\n          this.$nextTick(() => {\n            const textarea = this.$el.querySelector('.response-textarea');\n            textarea.scrollTop = textarea.scrollHeight;\n          });\n\n          // 新增：仅在收到结束标记时触发语音合成\n          if (response.isEnd) {\n            const cleanText = this.fullResponse\n              .replace(/<think>[\\s\\S]*?<\\/think>/g, '')\n              .replace(/[A-Za-z*]/g, '')\n              .trim();\n\n            if (cleanText) {\n              this.convertTextToSpeech(cleanText);\n            }\n            \n            this.fullResponse = ''; // 清空累积内容\n          }\n        });\n        \n        this.ws.addEventListener('open', () => {\n          console.log('WebSocket连接已建立');\n          resolve();\n        });\n\n        // 错误处理增强\n        this.ws.addEventListener('error', (error) => {\n          console.error('WebSocket错误:', error);\n          this.aiResponse = \"连接出现错误，请检查控制台\";\n        });\n\n        // 关闭处理\n        this.ws.addEventListener('close', () => {\n          console.log('WebSocket连接已关闭');\n          this.ws = null; // 重要！重置连接实例\n        });\n      });\n    },\n    \n    // 修改后的语音合成方法\n    async convertTextToSpeech(text) {\n      try {\n        const response = await fetch(\n          `http://localhost:4500/generate-tts?text=${encodeURIComponent(text)}`\n        );\n        const data = await response.json();\n        \n        if (data.audioUrl) {\n          this.playAudio(data.audioUrl);\n        } else {\n          console.error('音频生成失败:', data.error);\n        }\n      } catch (error) {\n        console.error('语音转换错误:', error);\n        this.aiResponse += '\\n[语音转换失败]';\n      }\n    },\n\n    playAudio(audioUrl) {\n      const audio = new Audio(audioUrl);\n      audio.play().catch((error) => {\n        console.error('播放音频错误:', error);\n      });\n    }\n  }\n}\n</script>\n\n<template>\n  <div class=\"app\">\n    <!-- 自定义ref=\"liveCanvas\"： -->\n    <canvas ref=\"liveCanvas\"></canvas>\n\n    <!-- 用户输入框 -->\n    <textarea\n      v-model=\"userQuestion\"\n      class=\"transparent-textarea\"\n      placeholder=\"输入你的问题...\"\n      @keydown.enter=\"sendQuestion\"\n    ></textarea>\n    \n    <!-- AI响应展示 -->\n    <textarea\n      :value=\"aiResponse\"\n      class=\"response-textarea\"\n      placeholder=\"AI的回复...\"\n      readonly\n    ></textarea>\n\n    <!-- 新增表情切换按钮 -->\n    <button \n      class=\"expression-btn_1\"\n      @click=\"changeExpression('1desk')\"\n      v-if=\"model\" \n    >\n      表情1\n    </button>\n\n      <button \n      class=\"expression-btn_2\"\n      @click=\"changeExpression('2mic')\"\n      v-if=\"model\" \n    >\n      表情2\n    </button>\n\n    <button \n      class=\"expression-btn_3\"\n      @click=\"changeExpression('5QAQ')\"\n      v-if=\"model\" \n    >\n      表情3\n    </button>\n\n    <button \n      class=\"expression-btn_4\"\n      @click=\"changeExpression('6i gi a ri')\"\n      v-if=\"model\" \n    >\n      表情4\n    </button>\n  </div>\n</template>\n\n<style scoped>\n.app {\n  background-image: url('/public/picture/behind02.jpg'); /* 设置背景图片 */\n  background-size: cover; /* 确保图片覆盖整个容器 */\n  background-position: center; /* 居中显示图片 */\n  background-attachment: fixed; /* 背景固定 */\n  height: 100vh; /* 高度设置为视口高度，确保背景覆盖整个页面 */\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  position: relative; /* 使得可以相对定位其他元素 */\n}\n\n.transparent-textarea {\n  position: absolute;\n  bottom: 7%; /* 设置距离页面底部的距离，使其在中间偏下 */\n  left: 50%; /* 水平居中 */\n  transform: translateX(-50%); /* 调整以确保输入框完全居中 */\n  padding: 10px;\n  font-size: 20px;\n  background-color: rgba(255, 255, 255, 0.8); /* 背景透明度50% */\n  border: 1px solid rgba(0, 0, 0, 0.3); /* 边框稍微透明 */\n  border-radius: 5px; /* 圆角 */\n  color: #333; /* 文本颜色 */\n  width: 60%; /* 宽度可以根据需要调整 */\n  min-height: 100px; /* 设置最小高度，使文本框足够高以容纳多行文本 */\n  resize: none; /* 禁止用户调整文本框大小 */\n  overflow: auto; /* 内容溢出时显示滚动条 */\n  white-space: pre-wrap; /* 保证文本在遇到长单词或链接时自动换行 */\n}\n\n.response-textarea {\n  position: absolute;\n  right: 4%; /* 设置距离页面右侧的距离 */\n  top: 20%; /* 设置距离页面顶部的距离 */\n  padding: 10px;\n  font-size: 16px;\n  background-color: rgba(255, 255, 255, 0.8); /* 背景透明度50% */\n  border: 1px solid rgba(0, 0, 0, 0.3); /* 边框稍微透明 */\n  border-radius: 5px; /* 圆角 */\n  color: #333; /* 文本颜色 */\n  width: 25%; /* 宽度可以根据需要调整 */\n  min-height: 400px; /* 设置最小高度 */\n  resize: none; /* 禁止用户调整文本框大小 */\n  overflow: auto; /* 内容溢出时显示滚动条 */\n  white-space: pre-wrap; /* 保证文本在遇到长单词或链接时自动换行 */\n}\n\n.expression-btn_1 {\n  position: absolute;\n  left: 4%;\n  top: 20%;\n  padding: 12px 24px;\n  font-size: 20px;\n  width: 10%;\n  background-color: rgba(106, 179, 240, 0.9);\n  border: none;\n  border-radius: 25px;\n  color: white;\n  cursor: pointer;\n  transition: all 0.3s ease;\n  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n}\n\n.expression-btn_2 {\n  position: absolute;\n  left: 4%;\n  top: 30%;\n  padding: 12px 24px;\n  font-size: 16px;\n  background-color: rgba(106, 179, 240, 0.9);\n  border: none;\n  border-radius: 25px;\n  color: white;\n  cursor: pointer;\n  transition: all 0.3s ease;\n  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n}\n\n.expression-btn_3 {\n  position: absolute;\n  left: 4%;\n  top: 40%;\n  padding: 12px 24px;\n  font-size: 16px;\n  background-color: rgba(106, 179, 240, 0.9);\n  border: none;\n  border-radius: 25px;\n  color: white;\n  cursor: pointer;\n  transition: all 0.3s ease;\n  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n}\n.expression-btn_4 {\n  position: absolute;\n  left: 4%;\n  top: 50%;\n  padding: 12px 24px;\n  font-size: 16px;\n  background-color: rgba(106, 179, 240, 0.9);\n  border: none;\n  border-radius: 25px;\n  color: white;\n  cursor: pointer;\n  transition: all 0.3s ease;\n  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n}\n</style>\n"],"mappings":";;EAwKOA,KAAK,EAAC;AAAK;;EAENC,GAAG,EAAC;AAAY;mBA1K5B;;uBAwKEC,mBAAA,CAoDM,OApDNC,UAoDM,GAnDJC,mBAAA,4BAA6B,EAC7BC,mBAAA,CAAkC,UAAlCC,UAAkC,+BAElCF,mBAAA,WAAc,E,gBACdC,mBAAA,CAKY;IAlLhB,uBAAAE,MAAA,QAAAA,MAAA,MAAAC,MAAA,IA8KeC,KAAA,CAAAC,YAAY,GAAAF,MAAA;IACrBR,KAAK,EAAC,sBAAsB;IAC5BW,WAAW,EAAC,WAAW;IACtBC,SAAO,EAAAL,MAAA,QAAAA,MAAA,MAjLdM,SAAA,KAAAC,IAAA,KAiLsBC,QAAA,CAAAC,YAAA,IAAAD,QAAA,CAAAC,YAAA,IAAAF,IAAA,CAAY;iEAHnBL,KAAA,CAAAC,YAAY,E,GAMvBN,mBAAA,YAAe,EACfC,mBAAA,CAKY;IAJTY,KAAK,EAAER,KAAA,CAAAS,UAAU;IAClBlB,KAAK,EAAC,mBAAmB;IACzBW,WAAW,EAAC,UAAU;IACtBQ,QAAQ,EAAR;0BAzLNC,UAAA,GA4LIhB,mBAAA,cAAiB,EAITK,KAAA,CAAAY,KAAK,I,cAHbnB,mBAAA,CAMS;IAnMboB,GAAA;IA8LMtB,KAAK,EAAC,kBAAkB;IACvBuB,OAAK,EAAAhB,MAAA,QAAAA,MAAA,MAAAC,MAAA,IAAEO,QAAA,CAAAS,gBAAgB;KAEzB,OAED,KAnMJpB,mBAAA,gBAwMYK,KAAA,CAAAY,KAAK,I,cAHXnB,mBAAA,CAMO;IA3MboB,GAAA;IAsMMtB,KAAK,EAAC,kBAAkB;IACvBuB,OAAK,EAAAhB,MAAA,QAAAA,MAAA,MAAAC,MAAA,IAAEO,QAAA,CAAAS,gBAAgB;KAEzB,OAED,KA3MJpB,mBAAA,gBAgNYK,KAAA,CAAAY,KAAK,I,cAHbnB,mBAAA,CAMS;IAnNboB,GAAA;IA8MMtB,KAAK,EAAC,kBAAkB;IACvBuB,OAAK,EAAAhB,MAAA,QAAAA,MAAA,MAAAC,MAAA,IAAEO,QAAA,CAAAS,gBAAgB;KAEzB,OAED,KAnNJpB,mBAAA,gBAwNYK,KAAA,CAAAY,KAAK,I,cAHbnB,mBAAA,CAMS;IA3NboB,GAAA;IAsNMtB,KAAK,EAAC,kBAAkB;IACvBuB,OAAK,EAAAhB,MAAA,QAAAA,MAAA,MAAAC,MAAA,IAAEO,QAAA,CAAAS,gBAAgB;KAEzB,OAED,KA3NJpB,mBAAA,e","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}