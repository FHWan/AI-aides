{"ast":null,"code":"import { createCommentVNode as _createCommentVNode, createElementVNode as _createElementVNode, vModelText as _vModelText, withKeys as _withKeys, withDirectives as _withDirectives, openBlock as _openBlock, createElementBlock as _createElementBlock } from \"vue\";\nconst _hoisted_1 = {\n  class: \"app\"\n};\nconst _hoisted_2 = {\n  ref: \"liveCanvas\"\n};\nconst _hoisted_3 = [\"value\"];\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  return _openBlock(), _createElementBlock(\"div\", _hoisted_1, [_createCommentVNode(\" è‡ªå®šä¹‰ref=\\\"liveCanvas\\\"ï¼š \"), _createElementVNode(\"canvas\", _hoisted_2, null, 512 /* NEED_PATCH */), _createCommentVNode(\" ç”¨æˆ·è¾“å…¥æ¡† \"), _withDirectives(_createElementVNode(\"textarea\", {\n    \"onUpdate:modelValue\": _cache[0] || (_cache[0] = $event => $data.userQuestion = $event),\n    class: \"transparent-textarea\",\n    placeholder: \"è¾“å…¥ä½ çš„é—®é¢˜...\",\n    onKeydown: _cache[1] || (_cache[1] = _withKeys((...args) => $options.sendQuestion && $options.sendQuestion(...args), [\"enter\"]))\n  }, null, 544 /* NEED_HYDRATION, NEED_PATCH */), [[_vModelText, $data.userQuestion]]), _createCommentVNode(\" AIå“åº”å±•ç¤º \"), _createElementVNode(\"textarea\", {\n    value: $data.aiResponse,\n    class: \"response-textarea\",\n    placeholder: \"AIçš„å›å¤...\",\n    readonly: \"\"\n  }, null, 8 /* PROPS */, _hoisted_3), _createCommentVNode(\" æ–°å¢è¡¨æƒ…åˆ‡æ¢æŒ‰é’® \"), $data.model ? (_openBlock(), _createElementBlock(\"button\", {\n    key: 0,\n    class: \"expression-btn_1\",\n    onClick: _cache[2] || (_cache[2] = $event => $options.changeExpression('1desk'))\n  }, \" é‡ç½®è¡¨æƒ…ğŸ˜€ \")) : _createCommentVNode(\"v-if\", true), $data.model ? (_openBlock(), _createElementBlock(\"button\", {\n    key: 1,\n    class: \"expression-btn_2\",\n    onClick: _cache[3] || (_cache[3] = $event => $options.changeExpression())\n  }, \" éšæœºè¡¨æƒ…ğŸ¤© \")) : _createCommentVNode(\"v-if\", true), $data.model ? (_openBlock(), _createElementBlock(\"button\", {\n    key: 2,\n    class: \"expression-btn_3\",\n    onClick: _cache[4] || (_cache[4] = $event => $options.change_test())\n  }, \" æµ‹è¯•æŒ‰é’® \")) : _createCommentVNode(\"v-if\", true)]);\n}","map":{"version":3,"names":["class","ref","_createElementBlock","_hoisted_1","_createCommentVNode","_createElementVNode","_hoisted_2","_cache","$event","$data","userQuestion","placeholder","onKeydown","_withKeys","args","$options","sendQuestion","value","aiResponse","readonly","_hoisted_3","model","key","onClick","changeExpression","change_test"],"sources":["/home/fan/docker_image/live2d/demo/src/App.vue"],"sourcesContent":["<script>\n// å¼•å…¥å¿…è¦çš„åº“\nimport * as PIXI from 'pixi.js';\nimport { Live2DModel } from 'pixi-live2d-display/cubism4';\nwindow.PIXI = PIXI; // ä¸ºäº†pixi-live2d-displayå†…éƒ¨è°ƒç”¨\nlet app; // ç”¨äºå­˜å‚¨pixiå®ä¾‹\n//let model; // ç”¨äºå­˜å‚¨live2då®ä¾‹\n\nexport default {\n  data() {\n    return {\n      userQuestion: '',\n      aiResponse: '',\n      ws: null,\n      audioUrl: '',\n      fullResponse: '', // æ–°å¢ï¼šç”¨äºç´¯ç§¯å®Œæ•´å“åº”\n      model: null, // å°†modelç§»åˆ°dataä¸­ä»¥ä¾¿Vueå“åº”å¼ç®¡ç†\n    };\n  },\n\n  async mounted() {\n    app = new PIXI.Application({\n      view: this.$refs.liveCanvas, // refç»„ä»¶ç»‘å®šï¼ŒliveCanvasä¸ºä¸‹æ–‡è‡ªå®šä¹‰çš„\n      autoStart: true,             // æ˜¯å¦å¼€å¯è‡ªåŠ¨æ’­æ”¾\n      resizeTo: window,\n      backgroundAlpha: 0,         // é€æ˜åº¦\n    });\n\n    // å°†modelå®ä¾‹ä¿å­˜åˆ°ç»„ä»¶dataä¸­\n    this.model = await Live2DModel.from('character/U.model3.json',{\n      // å±•ç¤ºå·¥å…·ç®±ï¼ˆå¯ä»¥æ§åˆ¶ live2d çš„å±•å‡ºéšè—ï¼Œä½¿ç”¨ç‰¹å®šè¡¨æƒ…ï¼‰\n      ShowToolBox: false,\n\n    // æ˜¯å¦ä½¿ç”¨ indexDB è¿›è¡Œç¼“å­˜ä¼˜åŒ–ï¼Œè¿™æ ·ä¸‹ä¸€æ¬¡è½½å…¥å°±ä¸ä¼šå†å‘èµ·ç½‘ç»œè¯·æ±‚äº†\n      LoadFromCache: true,\n      autoInteract: false, // å…³é—­çœ¼ç›è‡ªåŠ¨è·ŸéšåŠŸèƒ½\n    });\n    this.model.x = 500;\n    this.model.y = 100;\n    this.model.scale.set(1);\n    app.stage.addChild(this.model);\n    this.model.expression('æ¡Œ');\n  },\n\n  methods: {\n    // æ–°å¢è¡¨æƒ…åˆ‡æ¢æ–¹æ³•\n    changeExpression(text) {\n      if (this.model) {\n        this.model.expression(text);\n      }\n    },\n\n    change_test() {\n      setInterval(() => {\n        let n = Math.random();\n        console.log(\"éšæœºæ•°0~1æ§åˆ¶å˜´å·´Yè½´é«˜åº¦-->\", n);\n        this.model.internalModel.coreModel.setParameterValueById(\"ParamMouthOpenY\", n);\n      }, 100);\n    },\n\n    async sendQuestion(e) {\n      e.preventDefault();\n      if (!this.userQuestion.trim()) return;\n\n      // æ¸…ç©ºä¹‹å‰çš„å›å¤\n      this.aiResponse = ''; // æ¸…ç©ºå“åº”å†…å®¹\n\n      // ç¡®ä¿è¿æ¥å¯ç”¨\n      if (!this.ws || this.ws.readyState === WebSocket.CLOSED) {\n        await this.initWebSocket();\n      }\n\n      // ç¡®ä¿è¿æ¥å·²å»ºç«‹\n      if (this.ws.readyState === WebSocket.CONNECTING) {\n        await new Promise((resolve) => {\n          this.ws.addEventListener('open', resolve);\n        });\n      }\n\n      // å‘é€æ¶ˆæ¯\n      if (this.ws.readyState === WebSocket.OPEN) {\n        this.ws.send(this.userQuestion);\n        this.userQuestion = '';\n      } else {\n        console.error('WebSocketè¿æ¥å¼‚å¸¸çŠ¶æ€:', this.ws.readyState);\n        this.aiResponse = \"è¿æ¥å¼‚å¸¸ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•\";\n      }\n    },\n\n    initWebSocket() {\n      return new Promise((resolve) => {\n        if (this.ws) {\n          this.ws.close(); // å…³é—­æ—§è¿æ¥\n        }\n\n        this.ws = new WebSocket('ws://localhost:4600/question');\n        \n         // ä¿®æ”¹åçš„æ¶ˆæ¯ç›‘å¬\n         this.ws.addEventListener('message', (event) => {\n          const response = JSON.parse(event.data);\n          \n          // å¤„ç†é”™è¯¯æƒ…å†µ\n          if (response.error) {\n            this.aiResponse = response.error;\n            return;\n          }\n          this.model.expression('æ•²é”®ç›˜');  // å¼€å§‹å›å¤æ—¶åˆ‡æ¢è¡¨æƒ…\n          // å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡æ”¶åˆ°å›å¤ï¼Œåˆ‡æ¢ä¸ºâ€œæ•²é”®ç›˜â€è¡¨æƒ…\n         // if (this.aiResponse === '') {\n         //   this.model.expression('æ•²é”®ç›˜');  // å¼€å§‹å›å¤æ—¶åˆ‡æ¢è¡¨æƒ…\n         //}\n\n          // ç´¯ç§¯å“åº”å†…å®¹\n          if (response.data) {\n            this.aiResponse += response.data;\n            this.fullResponse += response.data; // ç´¯ç§¯å®Œæ•´å“åº”\n          }\n\n          // è‡ªåŠ¨æ»šåŠ¨\n          this.$nextTick(() => {\n            const textarea = this.$el.querySelector('.response-textarea');\n            textarea.scrollTop = textarea.scrollHeight;\n          });\n\n          // æ–°å¢ï¼šä»…åœ¨æ”¶åˆ°ç»“æŸæ ‡è®°æ—¶è§¦å‘è¯­éŸ³åˆæˆ\n          if (response.isEnd) {\n            const cleanText = this.fullResponse\n              .replace(/<think>[\\s\\S]*?<\\/think>/g, '')\n              .replace(/[A-Za-z*]/g, '')\n              .trim();\n\n            if (cleanText) {\n              this.convertTextToSpeech(cleanText);\n            }\n            \n            this.fullResponse = ''; // æ¸…ç©ºç´¯ç§¯å†…å®¹\n            // å›å¤å®Œå…¨ç»“æŸï¼Œåˆ‡æ¢ä¸ºâ€œæ¡Œâ€è¡¨æƒ…\n            this.model.expression('æ¡Œ');\n          }\n        });\n        \n        this.ws.addEventListener('open', () => {\n          console.log('WebSocketè¿æ¥å·²å»ºç«‹');\n          resolve();\n        });\n\n        // é”™è¯¯å¤„ç†å¢å¼º\n        this.ws.addEventListener('error', (error) => {\n          console.error('WebSocketé”™è¯¯:', error);\n          this.aiResponse = \"è¿æ¥å‡ºç°é”™è¯¯ï¼Œè¯·æ£€æŸ¥æ§åˆ¶å°\";\n        });\n\n        // å…³é—­å¤„ç†\n        this.ws.addEventListener('close', () => {\n          console.log('WebSocketè¿æ¥å·²å…³é—­');\n          this.ws = null; // é‡è¦ï¼é‡ç½®è¿æ¥å®ä¾‹\n        });\n      });\n    },\n    \n    // ä¿®æ”¹åçš„è¯­éŸ³åˆæˆæ–¹æ³•\n    async convertTextToSpeech(text) {\n      try {\n        const response = await fetch(\n          `http://localhost:4500/generate-tts?text=${encodeURIComponent(text)}`\n        );\n        const data = await response.json();\n        \n        if (data.audioUrl) {\n          this.playAudio(data.audioUrl);\n        } else {\n          console.error('éŸ³é¢‘ç”Ÿæˆå¤±è´¥:', data.error);\n        }\n      } catch (error) {\n        console.error('è¯­éŸ³è½¬æ¢é”™è¯¯:', error);\n        this.aiResponse += '\\n[è¯­éŸ³è½¬æ¢å¤±è´¥]';\n      }\n    },\n\n    playAudio(audioUrl) {\n      // åˆ›å»ºéŸ³é¢‘ä¸Šä¸‹æ–‡\n      const audioContext = new (window.AudioContext || window.webkitAudioContext)();\n      \n      // è·å–éŸ³é¢‘æ•°æ®\n      fetch(audioUrl)\n        .then(response => response.arrayBuffer())\n        .then(audioData => audioContext.decodeAudioData(audioData))\n        .then(audioBuffer => {\n          // åˆ›å»ºéŸ³é¢‘èŠ‚ç‚¹\n          const source = audioContext.createBufferSource();\n          const analyser = audioContext.createAnalyser();\n          \n          // é…ç½®åˆ†æå™¨\n          analyser.fftSize = 256;\n          source.buffer = audioBuffer;\n          \n          // è¿æ¥éŸ³é¢‘èŠ‚ç‚¹\n          source.connect(analyser);\n          analyser.connect(audioContext.destination);\n          \n          // åˆå§‹åŒ–åŠ¨ç”»å‚æ•°\n          let requestId = null;\n          const dataArray = new Uint8Array(analyser.frequencyBinCount);\n\n          // å¯åŠ¨éŸ³é¢‘æ’­æ”¾\n          source.start(0);\n\n          // åˆ›å»ºåŠ¨ç”»å¾ªç¯\n          const updateMouth = () => {\n            analyser.getByteFrequencyData(dataArray);\n            \n            // è®¡ç®—å¹³å‡éŸ³é‡\n            const volume = dataArray.reduce((a, b) => a + b) / dataArray.length;\n            const mouthOpen = Math.min(1, volume / 180); // è°ƒæ•´é™¤æ•°å¯æ”¹å˜çµæ•åº¦\n            \n            // æ›´æ–°æ¨¡å‹å‚æ•°\n            this.model.internalModel.coreModel.setParameterValueById(\n              \"ParamMouthOpenY\",\n              mouthOpen\n            );\n            \n            requestId = requestAnimationFrame(updateMouth);\n          };\n\n          // å¯åŠ¨åŠ¨ç”»\n          requestId = requestAnimationFrame(updateMouth);\n\n          // éŸ³é¢‘ç»“æŸæ—¶æ¸…ç†\n          source.onended = () => {\n            cancelAnimationFrame(requestId);\n            this.model.internalModel.coreModel.setParameterValueById(\n              \"ParamMouthOpenY\",\n              0\n            );\n            audioContext.close();\n          };\n        })\n        .catch(error => {\n          console.error('éŸ³é¢‘å¤„ç†é”™è¯¯:', error);\n          this.model.internalModel.coreModel.setParameterValueById(\n            \"ParamMouthOpenY\",\n            0\n          );\n        });\n    }\n  }\n}\n</script>\n\n<template>\n  <div class=\"app\">\n    <!-- è‡ªå®šä¹‰ref=\"liveCanvas\"ï¼š -->\n    <canvas ref=\"liveCanvas\"></canvas>\n\n    <!-- ç”¨æˆ·è¾“å…¥æ¡† -->\n    <textarea\n      v-model=\"userQuestion\"\n      class=\"transparent-textarea\"\n      placeholder=\"è¾“å…¥ä½ çš„é—®é¢˜...\"\n      @keydown.enter=\"sendQuestion\"\n    ></textarea>\n    \n    <!-- AIå“åº”å±•ç¤º -->\n    <textarea\n      :value=\"aiResponse\"\n      class=\"response-textarea\"\n      placeholder=\"AIçš„å›å¤...\"\n      readonly\n    ></textarea>\n\n    <!-- æ–°å¢è¡¨æƒ…åˆ‡æ¢æŒ‰é’® -->\n    <button \n      class=\"expression-btn_1\"\n      @click=\"changeExpression('1desk')\"\n      v-if=\"model\" \n    >\n      é‡ç½®è¡¨æƒ…ğŸ˜€\n    </button>\n\n      <button \n      class=\"expression-btn_2\"\n      @click=\"changeExpression()\"\n      v-if=\"model\" \n    >\n      éšæœºè¡¨æƒ…ğŸ¤©\n    </button>\n\n    <button \n      class=\"expression-btn_3\"\n      @click=\"change_test()\"\n      v-if=\"model\" \n    >\n      æµ‹è¯•æŒ‰é’®\n    </button>\n  </div>\n</template>\n\n<style scoped>\n.app {\n  background-image: url('/public/picture/behind02.jpg'); /* è®¾ç½®èƒŒæ™¯å›¾ç‰‡ */\n  background-size: cover; /* ç¡®ä¿å›¾ç‰‡è¦†ç›–æ•´ä¸ªå®¹å™¨ */\n  background-position: center; /* å±…ä¸­æ˜¾ç¤ºå›¾ç‰‡ */\n  background-attachment: fixed; /* èƒŒæ™¯å›ºå®š */\n  height: 100vh; /* é«˜åº¦è®¾ç½®ä¸ºè§†å£é«˜åº¦ï¼Œç¡®ä¿èƒŒæ™¯è¦†ç›–æ•´ä¸ªé¡µé¢ */\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  position: relative; /* ä½¿å¾—å¯ä»¥ç›¸å¯¹å®šä½å…¶ä»–å…ƒç´  */\n}\n\n.transparent-textarea {\n  position: absolute;\n  bottom: 7%; /* è®¾ç½®è·ç¦»é¡µé¢åº•éƒ¨çš„è·ç¦»ï¼Œä½¿å…¶åœ¨ä¸­é—´åä¸‹ */\n  left: 50%; /* æ°´å¹³å±…ä¸­ */\n  transform: translateX(-50%); /* è°ƒæ•´ä»¥ç¡®ä¿è¾“å…¥æ¡†å®Œå…¨å±…ä¸­ */\n  padding: 10px;\n  font-size: 20px;\n  background-color: rgba(255, 255, 255, 0.8); /* èƒŒæ™¯é€æ˜åº¦50% */\n  border: 1px solid rgba(0, 0, 0, 0.3); /* è¾¹æ¡†ç¨å¾®é€æ˜ */\n  border-radius: 5px; /* åœ†è§’ */\n  color: #333; /* æ–‡æœ¬é¢œè‰² */\n  width: 60%; /* å®½åº¦å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´ */\n  min-height: 100px; /* è®¾ç½®æœ€å°é«˜åº¦ï¼Œä½¿æ–‡æœ¬æ¡†è¶³å¤Ÿé«˜ä»¥å®¹çº³å¤šè¡Œæ–‡æœ¬ */\n  resize: none; /* ç¦æ­¢ç”¨æˆ·è°ƒæ•´æ–‡æœ¬æ¡†å¤§å° */\n  overflow: auto; /* å†…å®¹æº¢å‡ºæ—¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */\n  white-space: pre-wrap; /* ä¿è¯æ–‡æœ¬åœ¨é‡åˆ°é•¿å•è¯æˆ–é“¾æ¥æ—¶è‡ªåŠ¨æ¢è¡Œ */\n}\n\n.response-textarea {\n  position: absolute;\n  right: 4%; /* è®¾ç½®è·ç¦»é¡µé¢å³ä¾§çš„è·ç¦» */\n  top: 20%; /* è®¾ç½®è·ç¦»é¡µé¢é¡¶éƒ¨çš„è·ç¦» */\n  padding: 10px;\n  font-size: 16px;\n  background-color: rgba(255, 255, 255, 0.8); /* èƒŒæ™¯é€æ˜åº¦50% */\n  border: 1px solid rgba(0, 0, 0, 0.3); /* è¾¹æ¡†ç¨å¾®é€æ˜ */\n  border-radius: 5px; /* åœ†è§’ */\n  color: #333; /* æ–‡æœ¬é¢œè‰² */\n  width: 25%; /* å®½åº¦å¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´ */\n  min-height: 400px; /* è®¾ç½®æœ€å°é«˜åº¦ */\n  resize: none; /* ç¦æ­¢ç”¨æˆ·è°ƒæ•´æ–‡æœ¬æ¡†å¤§å° */\n  overflow: auto; /* å†…å®¹æº¢å‡ºæ—¶æ˜¾ç¤ºæ»šåŠ¨æ¡ */\n  white-space: pre-wrap; /* ä¿è¯æ–‡æœ¬åœ¨é‡åˆ°é•¿å•è¯æˆ–é“¾æ¥æ—¶è‡ªåŠ¨æ¢è¡Œ */\n}\n\n.expression-btn_1 {\n  position: absolute;\n  right: 18.1%;\n  top: 63%;\n  padding: 12px 24px;\n  font-size: 20px;\n  width: 12%;\n  background-color: rgba(106, 240, 128, 0.9);\n  border: none;\n  border-radius: 25px;\n  color: rgb(0, 0, 0);\n  cursor: pointer;\n  transition: all 0.3s ease;\n  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n}\n\n.expression-btn_2 {\n  position: absolute;\n  right: 4%;\n  top: 63%;\n  padding: 12px 24px;\n  font-size: 20px;\n  width: 12%;\n  background-color: rgba(106, 240, 128, 0.9);\n  border: none;\n  border-radius: 25px;\n  color: rgb(0, 0, 0);\n  cursor: pointer;\n  transition: all 0.3s ease;\n  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n}\n\n.expression-btn_3 {\n  position: absolute;\n  right: 12%;\n  top: 70%;\n  padding: 12px 24px;\n  font-size: 20px;\n  width: 10%;\n  background-color: rgba(106, 179, 240, 0.9);\n  border: none;\n  border-radius: 25px;\n  color: white;\n  cursor: pointer;\n  transition: all 0.3s ease;\n  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n}\n\n</style>\n"],"mappings":";;EA0POA,KAAK,EAAC;AAAK;;EAENC,GAAG,EAAC;AAAY;mBA5P5B;;uBA0PEC,mBAAA,CA4CM,OA5CNC,UA4CM,GA3CJC,mBAAA,4BAA6B,EAC7BC,mBAAA,CAAkC,UAAlCC,UAAkC,+BAElCF,mBAAA,WAAc,E,gBACdC,mBAAA,CAKY;IApQhB,uBAAAE,MAAA,QAAAA,MAAA,MAAAC,MAAA,IAgQeC,KAAA,CAAAC,YAAY,GAAAF,MAAA;IACrBR,KAAK,EAAC,sBAAsB;IAC5BW,WAAW,EAAC,WAAW;IACtBC,SAAO,EAAAL,MAAA,QAAAA,MAAA,MAnQdM,SAAA,KAAAC,IAAA,KAmQsBC,QAAA,CAAAC,YAAA,IAAAD,QAAA,CAAAC,YAAA,IAAAF,IAAA,CAAY;iEAHnBL,KAAA,CAAAC,YAAY,E,GAMvBN,mBAAA,YAAe,EACfC,mBAAA,CAKY;IAJTY,KAAK,EAAER,KAAA,CAAAS,UAAU;IAClBlB,KAAK,EAAC,mBAAmB;IACzBW,WAAW,EAAC,UAAU;IACtBQ,QAAQ,EAAR;0BA3QNC,UAAA,GA8QIhB,mBAAA,cAAiB,EAITK,KAAA,CAAAY,KAAK,I,cAHbnB,mBAAA,CAMS;IArRboB,GAAA;IAgRMtB,KAAK,EAAC,kBAAkB;IACvBuB,OAAK,EAAAhB,MAAA,QAAAA,MAAA,MAAAC,MAAA,IAAEO,QAAA,CAAAS,gBAAgB;KAEzB,UAED,KArRJpB,mBAAA,gBA0RYK,KAAA,CAAAY,KAAK,I,cAHXnB,mBAAA,CAMO;IA7RboB,GAAA;IAwRMtB,KAAK,EAAC,kBAAkB;IACvBuB,OAAK,EAAAhB,MAAA,QAAAA,MAAA,MAAAC,MAAA,IAAEO,QAAA,CAAAS,gBAAgB;KAEzB,UAED,KA7RJpB,mBAAA,gBAkSYK,KAAA,CAAAY,KAAK,I,cAHbnB,mBAAA,CAMS;IArSboB,GAAA;IAgSMtB,KAAK,EAAC,kBAAkB;IACvBuB,OAAK,EAAAhB,MAAA,QAAAA,MAAA,MAAAC,MAAA,IAAEO,QAAA,CAAAU,WAAW;KAEpB,QAED,KArSJrB,mBAAA,e","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}